---
title: "R Notebook"
output: html_notebook
---


# Initial Analysis

## Load libraries

```{r}
library("data.table")
library("tidyverse")
library("ggplot2")
library("lubridate")
library("leaflet")
library("leaflet.extras")
library("geosphere")
```

## Some parameter settings

```{r}
SEED=20190216
```

## Load data

```{r}
train_dt = fread("../data/raw/train.csv")
test_dt = fread("../data/raw/test.csv")
```

```{r}
# data from 02_OSRM.Rmd
#fast_route = readRDS("../data/interim/fast_route_basic.RDS")
```


```{r}
c(nrow(train_dt), nrow(test_dt))
head(train_dt)
head(test_dt)
```

`start_timestamp` is an unix time.


## Missing Values

```{r}
sum(is.na(train_dt))
sum(is.na(test_dt))
```

## Combining train and test

```{r}
cb_dt = bind_rows(train_dt %>% mutate(dset = "train"), 
                   test_dt %>% mutate(dset = "test",
                                     duration = NA))
cb_dt = cb_dt %>% mutate(dset = factor(dset))
```

### Time range for train and test

```{r}
ggplot(cb_dt %>% sample_n(10000), aes(x = start_timestamp, y = dset)) + geom_point() + theme_bw(base_size = 15)
```

It seems that the time range is overlapped between training and testing set.

### Location range for train and test

```{r}
set.seed(SEED)

tmp = cb_dt %>% group_by(dset) %>% sample_n(5000)

tmp %>%
  filter(start_lng > -75 & start_lng < -73) %>%
  filter(start_lat > 40 & start_lat < 42) %>%
  ggplot(aes(x = start_lng, y = start_lat, color = dset)) + 
  geom_point(alpha = 0.1, size = 0.2) + 
  coord_cartesian(xlim = c(-74.02,-73.77), ylim = c(40.63,40.84)) +
  facet_wrap(~dset)

tmp %>% 
  filter(dset == "train") %>%
  leaflet %>% 
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircleMarkers(~ start_lng, ~start_lat, radius = 1,
                   color = "blue", fillOpacity = 0.3)

tmp %>% 
  filter(dset == "test") %>%
  leaflet %>% 
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircleMarkers(~ start_lng, ~start_lat, radius = 1,
                   color = "red", fillOpacity = 0.3)
```

The location mostly focus on Manhattan area.  Another notable hot-spot is JFK and Laguadia airport.



## Feature transform

I think I can safely assume the origin date for UNIX time is 1970-01-01. However, the time zone can be tricky. I assume the number of taxi trips during the night are usually less than those during the day. The current time zone seems to make sense.

```{r}
#train_dt = 
train_dt %>%
  mutate(pickup_datetime = with_tz(
    as_datetime(
      as.POSIXct(start_timestamp, origin="1970-01-01")
      ))
  ) %>% 
  mutate(hour = hour(pickup_datetime),
         month = as.integer(month(pickup_datetime)),
         wday =  wday(pickup_datetime, label = TRUE),
         wday = as.integer(fct_relevel(wday, c("Sun", "Sat", "Mon", "Tues", "Wed", "Thurs", "Fri"))),
         )
```


```{r}
  group_by(hpick) %>%
  summarise(median_duration = median(duration)/60) %>%
  ggplot(aes(hpick, median_duration)) +
  geom_smooth(method = "loess", span = 1/2) +
  geom_point(size = 4) +
  labs(x = "Hour of the day", y = "Median trip duration [min]") +
  theme(legend.position = "none")
  
  #mutate(pickup_datetime = )
```


```{r}
train_dt %>%
  mutate(hpick = hour(pickup_datetime)) %>%
  group_by(hpick, vendor_id) %>%
  summarise(median_duration = median(trip_duration)/60) %>%
  ggplot(aes(hpick, median_duration, color = vendor_id)) +
  geom_smooth(method = "loess", span = 1/2) +
  geom_point(size = 4) +
  labs(x = "Hour of the day", y = "Median trip duration [min]") +
  theme(legend.position = "none")
```


```
```


Subsampling to get a subset for analysis.

```{r}
fwrite(train_dt %>% sample_frac(0.1), file = "../data/raw/train_sub.csv")
```


# Final Feature Engineering

```{r}
train_dt = fread("../data/raw/train.csv")
test_dt = fread("../data/raw/test.csv")

# airport location
jfk_coord = tibble(lon = -73.778889, lat = 40.639722)
la_guardia_coord = tibble(lon = -73.872611, lat = 40.77725)


cb_dt = bind_rows(train_dt %>% mutate(dset = "train"), 
                   test_dt %>% mutate(dset = "test",
                                     duration = NA))
cb_dt = cb_dt %>% mutate(dset = factor(dset))
```
## Distance related

```{r}
pick_coord <- cb_dt %>%
  select(start_lng, start_lat)
drop_coord <- cb_dt %>%
  select(end_lng, end_lat)

cb_dt$dist = distCosine(pick_coord, drop_coord)
cb_dt$bearing = bearing(pick_coord, drop_coord)

cb_dt$jfk_pick <- distCosine(pick_coord, jfk_coord)
cb_dt$jfk_drop <- distCosine(drop_coord, jfk_coord)
cb_dt$lg_pick <- distCosine(pick_coord, la_guardia_coord)
cb_dt$lg_drop <- distCosine(drop_coord, la_guardia_coord)

cb_dt <- cb_dt %>%
  mutate(speed = dist/duration*3.6,
         jfk_trip = (jfk_pick < 2e3) | (jfk_drop < 2e3),
         lg_trip = (lg_pick < 2e3) | (lg_drop < 2e3),
         center_latitude = (start_lat + end_lat)/2,
         center_longitude = (start_lng + end_lng)/2
         ) %>%
  rename(pickup_longitude = start_lng, pickup_latitude = start_lat, 
         dropoff_longitude = end_lng, dropoff_latitude = end_lat)
```
## Time related

```{r}
cb_dt = cb_dt %>%
  mutate(pickup_datetime = with_tz(
    as_datetime(
      as.POSIXct(start_timestamp, origin="1970-01-01")
      ))
  ) %>% 
  mutate(date = date(pickup_datetime),
         month = month(pickup_datetime),
         wday = wday(pickup_datetime, label = TRUE),
         wday = as.integer(fct_relevel(wday, c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))),
         hour = hour(pickup_datetime),
         minute = minute(pickup_datetime),
         whour = wday*24 + hour,
         yday = yday(pickup_datetime),
         work = (hour %in% seq(8,18)) & (wday %in% c("Mon","Tue","Wed","Thu","Fri")))
```

## Removing outliers

Removing trips that taking more than one day or less than 10 seconds.

```{r}
cb_dt = cb_dt %>% 
  filter((dset == "test") | (duration < 24*3600 & duration > 10))
```

```{r}
# make sure we still have the same test set.
table(cb_dt$dset)
c(nrow(train_dt), nrow(test_dt))
```

## Save to files

```{r}
# for evaluation
set.seed(SEED)

train_dt = cb_dt %>% filter(dset == "train") %>% sample_n(1000) # will delete sample_n after testing the python code
smp_size = floor(0.75 * nrow(train_dt))
train_ind = sample(seq_len(nrow(train_dt)), size = smp_size)

fwrite(train_dt[train_ind, ], file = "../data/processed/train_eval.csv")
fwrite(train_dt[-train_ind, ], file = "../data/processed/test_eval.csv")

fwrite(cb_dt %>% filter(dset == "train"), file = "../data/processed/train.csv")
fwrite(cb_dt %>% filter(dset == "test"), file = "../data/processed/test.csv")
```
