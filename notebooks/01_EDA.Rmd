---
title: "R Notebook"
output: html_notebook
---


# Initial Analysis

## Load libraries

```{r}
library("data.table")
library("tidyverse")
library("ggplot2")
library("lubridate")
library("leaflet")
library("leaflet.extras")
```

## Some parameter settings

```{r}
SEED=20190216
```

## Load data

```{r}
train_dt = fread("../data/raw/train.csv")
test_dt = fread("../data/raw/test.csv")
```

```{r}
c(nrow(train_dt), nrow(test_dt))
head(train_dt)
head(test_dt)
```

`start_timestamp` is an unix time.


## Missing Values

```{r}
sum(is.na(train_dt))
sum(is.na(test_dt))
```

## Combining train and test

```{r}
cb_dt <- bind_rows(train_dt %>% mutate(dset = "train"), 
                   test_dt %>% mutate(dset = "test",
                                     duration = NA))
cb_dt <- cb_dt %>% mutate(dset = factor(dset))
```

### Time range for train and test

```{r}
ggplot(cb_dt %>% sample_n(10000), aes(x = start_timestamp, y = dset)) + geom_point() + theme_bw(base_size = 15)
```

It seems that the time range is overlapped between training and testing set.

### Location range for train and test

```{r}
set.seed(SEED)

tmp = cb_dt %>% group_by(dset) %>% sample_n(5000)

tmp %>%
  ggplot(aes(x = start_lng, y = start_lat, color = dset)) + geom_point(alpha = 0.1) + facet_wrap(~dset)

tmp %>% 
  filter(dset == "train") %>%
  leaflet %>% 
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircleMarkers(~ start_lng, ~start_lat, radius = 1,
                   color = "blue", fillOpacity = 0.3)

tmp %>% 
  filter(dset == "test") %>%
  leaflet %>% 
  addProviderTiles("Esri.NatGeoWorldMap") %>%
  addCircleMarkers(~ start_lng, ~start_lat, radius = 1,
                   color = "red", fillOpacity = 0.3)
```

The location mostly focus on Manhattan area.  Another notable hot-spot is JFK and Laguadia airport.



## Feature transform

I think I can safely assume the origin date for UNIX time is 1970-01-01. However, the time zone can be tricky. I assume the number of taxi trips during the night are usually less than those during the day. The current time zone seems to make sense.

```{r}
#train_dt = 
train_dt %>%
  mutate(pickup_datetime = with_tz(
    as_datetime(
      as.POSIXct(start_timestamp, origin="1970-01-01")
      ))
  ) %>% 
  #{range(.$start_datetime)}

  mutate(hpick = hour(pickup_datetime)) %>%
  group_by(hpick) %>%
  summarise(median_duration = median(duration)/60) %>%
  ggplot(aes(hpick, median_duration)) +
  geom_smooth(method = "loess", span = 1/2) +
  geom_point(size = 4) +
  labs(x = "Hour of the day", y = "Median trip duration [min]") +
  theme(legend.position = "none")
  
  #mutate(pickup_datetime = )
```


```{r}
train_dt %>%
  mutate(hpick = hour(pickup_datetime)) %>%
  group_by(hpick, vendor_id) %>%
  summarise(median_duration = median(trip_duration)/60) %>%
  ggplot(aes(hpick, median_duration, color = vendor_id)) +
  geom_smooth(method = "loess", span = 1/2) +
  geom_point(size = 4) +
  labs(x = "Hour of the day", y = "Median trip duration [min]") +
  theme(legend.position = "none")
```


```
```


Subsampling to get a subset for analysis.

```{r}
fwrite(train_dt %>% sample_frac(0.1), file = "../data/raw/train_sub.csv")
```






